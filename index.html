<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Homothétie</title>

  <!-- Polices -->
  <link href="https://fonts.googleapis.com/css2?family=Androgy+Demo&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Mabry+Pro&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #5b6dfa;
      --secondary: #00bfa6;
      --accent: #ff6b6b;
      --grid: #e0e0e0;
      --border-radius: 10px;
    }

    body {
      margin: 0;
      font-family: 'Mabry Pro', sans-serif;
      background: #f9f9f9;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }

    h1 {
      font-family: 'Androgy Demo', sans-serif;
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .question-box {
      text-align: center;
      margin-bottom: 1rem;
    }
    #question {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }
    #progress {
      font-weight: bold;
      color: var(--secondary);
    }
    #feedback {
      margin-top: 0.5rem;
      font-weight: bold;
    }

    #grid {
      width: 800px;
      height: 450px; /* format 16/9 */
      background: white;
      border: 2px solid var(--grid);
      border-radius: var(--border-radius);
      margin: 1rem 0;
    }
    svg { width: 100%; height: 100%; cursor: crosshair; }

    .btn {
      padding: 0.7rem 1.2rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
      margin: 0.5rem;
    }
    .btn:hover { background: var(--secondary); }

    .point { fill: var(--accent); stroke: black; stroke-width: 1; cursor: grab; }
    .point:active { cursor: grabbing; }
  </style>
</head>
<body>

  <h1>Homothétie</h1>

  <div class="question-box">
    <div id="question">Question</div>
    <div id="progress">1 / 10</div>
    <div id="feedback"></div>
  </div>

  <div id="grid"><svg id="svgGrid"></svg></div>

  <div>
    <button class="btn" onclick="goHome()">Retour à l’accueil</button>
    <button class="btn" onclick="resetPoints()">Réinitialiser</button>
    <button class="btn" onclick="nextQuestion()">Question suivante</button>
  </div>

  <script>
    const svg = document.getElementById("svgGrid");
    const gridSize = 20, cols = 40, rows = 22;
    let current = 0, userPts = [], expected = [];
    let dragging = null;

    // valeurs de rapport possibles
    const ratios = [-3,-2,-1,-0.5,0.5,1,2,3];

    // Génère un entier multiple de gridSize
    function randCoord(max) {
      return Math.floor(Math.random()*max/gridSize)*gridSize;
    }

    // Génère une figure aléatoire
    function randomFigure() {
      const O = {x: randCoord(cols*gridSize), y: randCoord(rows*gridSize)};
      const type = ["triangle","carré","rectangle"][Math.floor(Math.random()*3)];
      let pts=[];
      if(type==="triangle"){
        pts = [
          {x:O.x+randCoord(10*gridSize)-100, y:O.y+randCoord(8*gridSize)-80},
          {x:O.x+randCoord(10*gridSize)-100, y:O.y+randCoord(8*gridSize)-80},
          {x:O.x+randCoord(10*gridSize)-100, y:O.y+randCoord(8*gridSize)-80}
        ];
      } else if(type==="carré"){
        const size = (Math.floor(Math.random()*5)+2)*gridSize;
        pts = [
          {x:O.x+size, y:O.y},
          {x:O.x+size, y:O.y+size},
          {x:O.x, y:O.y+size},
          {x:O.x, y:O.y}
        ];
      } else if(type==="rectangle"){
        const w = (Math.floor(Math.random()*6)+3)*gridSize;
        const h = (Math.floor(Math.random()*4)+2)*gridSize;
        pts = [
          {x:O.x+w, y:O.y},
          {x:O.x+w, y:O.y+h},
          {x:O.x, y:O.y+h},
          {x:O.x, y:O.y}
        ];
      }
      const k = ratios[Math.floor(Math.random()*ratios.length)];
      return {
        text:`Construire l’image du ${type} par homothétie de rapport ${k}`,
        O, pts, k
      };
    }

    // Génération de 10 questions
    const questions = Array.from({length:10}, ()=>randomFigure());

    function el(tag,attrs={}){const e=document.createElementNS("http://www.w3.org/2000/svg",tag);for(const k in attrs)e.setAttribute(k,attrs[k]);return e;}
    function clear(){while(svg.firstChild)svg.removeChild(svg.firstChild);}
    function drawGrid(){
      for(let i=0;i<=cols;i++) svg.appendChild(el("line",{x1:i*gridSize,y1:0,x2:i*gridSize,y2:rows*gridSize,stroke:"#e0e0e0"}));
      for(let j=0;j<=rows;j++) svg.appendChild(el("line",{x1:0,y1:j*gridSize,x2:cols*gridSize,y2:j*gridSize,stroke:"#e0e0e0"}));
    }
    function drawPoly(pts,color){
      svg.appendChild(el("polygon",{points:pts.map(p=>`${p.x},${p.y}`).join(" "),fill:color,stroke:"purple","stroke-width":2}));
    }
    function drawPoint(p,isUser=false){
      const circle = el("circle",{cx:p.x,cy:p.y,r:5,fill:varColor(p,isUser),stroke:"black"});
      if(isUser){
        circle.classList.add("point");
        circle.addEventListener("mousedown", ()=>{dragging=circle;});
      }
      svg.appendChild(circle);
      return circle;
    }
    function varColor(p,isUser){ return isUser ? "#ff6b6b" : "#5b6dfa"; }
    function snap(x,y){return {x:Math.round(x/gridSize)*gridSize,y:Math.round(y/gridSize)*gridSize};}
    function homothety(O,P,k){return snap(O.x+k*(P.x-O.x),O.y+k*(P.y-O.y));}

    function render(idx){
      clear(); drawGrid();
      userPts = [];
      const q = questions[idx];
      drawPoly(q.pts,"rgba(91,109,250,0.25)");
      q.pts.forEach(p=>drawPoint(p));
      drawPoint(q.O);
      expected = q.pts.map(p=>homothety(q.O,p,q.k));
      document.getElementById("question").textContent = q.text;
      document.getElementById("progress").textContent = (idx+1)+" / "+questions.length;
      document.getElementById("feedback").textContent = "";
    }

    function nextQuestion(){
      if(current < questions.length-1){ current++; render(current);}
      else alert("Quiz terminé !");
    }

    function resetPoints(){
      const circles = svg.querySelectorAll(".point");
      circles.forEach(c => c.remove());
      userPts = [];
      document.getElementById("feedback").textContent = "";
    }

    function checkAnswer(){
      if(userPts.length !== expected.length) return;
      const ok = userPts.every((p,i)=>Math.abs(p.x-expected[i].x)<1 && Math.abs(p.y-expected[i].y)<1);
      if(ok){
        drawPoly(userPts,"rgba(0,200,0,0.3)");
        document.getElementById("feedback").textContent = "✅ Bravo, c’est correct !";
        document.getElementById("feedback").style.color = "green";
      } else {
        drawPoly(userPts,"rgba(255,0,0,0.3)");
        drawPoly(expected,"rgba(131,56,236,0.3)");
        document.getElementById("feedback").textContent = "❌ Mauvaise réponse. La figure correcte est affichée en violet.";
        document.getElementById("feedback").style.color = "red";
      }
    }

    svg.addEventListener("click", e=>{
      if(userPts.length >= expected.length || dragging) return;
      const pt = svg.createSVGPoint();
      pt.x = e.clientX; pt.y = e.clientY;
      const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
      const snapped = snap(svgP.x,svgP.y);
      userPts.push(snapped);
      drawPoint(snapped,true);
      if(userPts.length === expected.length) checkAnswer();
    });

    svg.addEventListener("mousemove", e=>{
      if(dragging){
        const pt = svg.createSVGPoint();
        pt.x = e.clientX; pt.y = e.clientY;
        const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
        const snapped = snap(svgP.x,svgP.y);
        dragging.setAttribute("cx",snapped.x);
        dragging.setAttribute("cy",snapped.y);
      }
    });
    svg.addEventListener("mouseup", ()=>{
      if(dragging){
        const idx = Array.from(svg.querySelectorAll(".point")).indexOf(dragging);
        if(idx>=0) userPts[idx] = {x:+dragging.getAttribute("cx"), y:+dragging.getAttribute("cy")};
        dragging = null;
        if(userPts.length === expected.length) checkAnswer();
      }
    });

    function goHome() {
      window.location.href = "index.html"; 
    }

    render(current);
  </script>
  
</body>
</html>
