<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Quiz Homothétie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f8f9fa;
      height: 100vh;
      margin: 0;
    }
    #app {
      display: flex;
      width: 90%;
      height: 90%;
    }
    #left-panel {
      width: 20%;
      padding: 10px;
      text-align: center;
    }
    #canvas-container {
      flex-grow: 1;
      position: relative;
    }
    canvas {
      border: 1px solid #ccc;
      background: white;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    #question {
      font-weight: bold;
      margin: 10px 0;
    }
    #feedback {
      margin-top: 10px;
      font-weight: bold;
    }
    button {
      margin-top: 15px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #3a86ff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #265dbe;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="left-panel">
      <h1>Homothétie</h1>
      <div id="question">Place les points A’, B’, C’, D’</div>
      <div id="feedback"></div>
      <button onclick="resetAll()">Réinitialiser</button>
    </div>
    <div id="canvas-container">
      <canvas id="gridCanvas"></canvas>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gridCanvas");
    const ctx = canvas.getContext("2d");
    let width = canvas.parentElement.clientWidth;
    let height = canvas.parentElement.clientHeight;
    canvas.width = width;
    canvas.height = height;

    const cols = 30, rows = 40;
    const cellSize = Math.min(width / cols, height / rows);

    // Figure de départ
    const baseFigure = [
      {x: 5, y: 5}, {x: 10, y: 5}, {x: 10, y: 10}, {x: 5, y: 10}
    ];

    // Centre O (aléatoire)
    let O = { 
      x: Math.floor(Math.random() * (cols-10)) + 5, 
      y: Math.floor(Math.random() * (rows-10)) + 5 
    };

    const k = 2; // rapport
    let correctFigure = baseFigure.map(p => ({
      x: O.x + k*(p.x - O.x),
      y: O.y + k*(p.y - O.y)
    }));

    // Points posés par l'élève
    let studentPoints = [];
    let draggingPoint = null;

    function drawGrid() {
      ctx.clearRect(0, 0, width, height);
      ctx.strokeStyle = "#eee";
      for (let i = 0; i <= cols; i++) {
        ctx.beginPath();
        ctx.moveTo(i*cellSize, 0);
        ctx.lineTo(i*cellSize, rows*cellSize);
        ctx.stroke();
      }
      for (let j = 0; j <= rows; j++) {
        ctx.beginPath();
        ctx.moveTo(0, j*cellSize);
        ctx.lineTo(cols*cellSize, j*cellSize);
        ctx.stroke();
      }

      // Point O
      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.arc(O.x*cellSize, O.y*cellSize, 5, 0, 2*Math.PI);
      ctx.fill();

      // Figure de départ
      ctx.fillStyle = "rgba(100, 100, 255, 0.3)";
      ctx.beginPath();
      ctx.moveTo(baseFigure[0].x*cellSize, baseFigure[0].y*cellSize);
      baseFigure.forEach(p => ctx.lineTo(p.x*cellSize, p.y*cellSize));
      ctx.closePath();
      ctx.fill();

      // Points élèves
      studentPoints.forEach((p, idx) => {
        ctx.fillStyle = "blue";
        ctx.beginPath();
        ctx.arc(p.x*cellSize, p.y*cellSize, 6, 0, 2*Math.PI);
        ctx.fill();
        ctx.fillText(["A’","B’","C’","D’"][idx], p.x*cellSize+5, p.y*cellSize-5);
      });

      // Figure de l’élève si complète
      if (studentPoints.length === 4) {
        ctx.fillStyle = compareFigures(studentPoints, correctFigure) 
          ? "rgba(0,200,0,0.3)" 
          : "rgba(200,0,0,0.3)";
        ctx.beginPath();
        ctx.moveTo(studentPoints[0].x*cellSize, studentPoints[0].y*cellSize);
        studentPoints.forEach(p => ctx.lineTo(p.x*cellSize, p.y*cellSize));
        ctx.closePath();
        ctx.fill();

        if (!compareFigures(studentPoints, correctFigure)) {
          // Affiche correction
          ctx.fillStyle = "rgba(150,0,200,0.3)";
          ctx.beginPath();
          ctx.moveTo(correctFigure[0].x*cellSize, correctFigure[0].y*cellSize);
          correctFigure.forEach(p => ctx.lineTo(p.x*cellSize, p.y*cellSize));
          ctx.closePath();
          ctx.fill();
        }
      }
    }

    function compareFigures(fig1, fig2) {
      return fig1.every((p,i) => 
        Math.abs(p.x-fig2[i].x)<0.5 && Math.abs(p.y-fig2[i].y)<0.5
      );
    }

    function resetAll() {
      studentPoints = [];
      draggingPoint = null;
      document.getElementById("feedback").innerText = "";
      drawGrid();
    }

    // Drag & Drop des points
    canvas.addEventListener("mousedown", e => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left)/cellSize;
      const y = (e.clientY - rect.top)/cellSize;
      for (let p of studentPoints) {
        if (Math.hypot(p.x-x, p.y-y) < 0.5) {
          draggingPoint = p;
          return;
        }
      }
      if (studentPoints.length < 4) {
        studentPoints.push({x: Math.round(x), y: Math.round(y)});
      }
      drawGrid();
    });

    canvas.addEventListener("mousemove", e => {
      if (draggingPoint) {
        const rect = canvas.getBoundingClientRect();
        draggingPoint.x = Math.round((e.clientX - rect.left)/cellSize);
        draggingPoint.y = Math.round((e.clientY - rect.top)/cellSize);
        drawGrid();
      }
    });

    canvas.addEventListener("mouseup", () => {
      if (studentPoints.length === 4) {
        let ok = compareFigures(studentPoints, correctFigure);
        document.getElementById("feedback").innerText = ok 
          ? "✅ Bravo, c’est correct !" 
          : "❌ Mauvaise réponse. La figure correcte apparaît en violet.";
      }
      draggingPoint = null;
    });

    drawGrid();
  </script>
</body>
</html>
